define('io.ox/dynamic-theme/register', [
    'settings!io.ox/dynamic-theme',
    'io.ox/dynamic-theme/themes',
    'text!io.ox/dynamic-theme/apps/themes/style.less.dyn',
    'less'
], function (settings, themes, coreTheme, lessPlugin) {
    'use strict';

    var less = (function () {
        var less = { tree: {} }, exports = less;
        function require(name) {
            return less[name.split("/")[1]];
        }
        (function () {
            var window; // pretend we're not in a browser
            {{>parser}}
        }());
        {{>functions}}
        {{>colors}}
        {{>tree}}
        {{#each (glob "lib/node_modules/less/lib/less/tree/*.js")}}
            {{{read .}}}
        {{/each}}
        {{>env}}
        {{>visitor}}
        {{>import-visitor}}
        {{>join-selector-visitor}}
        {{>to-css-visitor}}
        {{>extend-visitor}}
        {{>browser}}
        {{>source-map-output}}
        return less;
    }());

    themes = _.reduce(themes, function (o, v) { o[v] = true; return o; }, {});

    var data = [], colors = settings.get();
    colors.logoWidth = colors.logoWidth + 'px';
    colors.logoURL = 'url(' + colors.logoURL + ')';
    for (var i in colors) {
        data.push('@io-ox-dynamic-theme-' + i + ': ' + colors[i] + ';\n');
    }
    var header = data.join('');

    process(coreTheme);

    function process(file) {
        function error(e) {
            if (('console' in window) && console.error) console.error(e);
        }
        console.time('process');
        new less.Parser().parse(header + file, function (e, root) {
            if (e) return error(e);
            try {
                var css = root.toCSS();
                if (css) {
                    $('<style type="text/css">').text(css)
                        .insertAfter('#custom');
                }
            } catch (e) { error(e); }
            console.timeEnd('process');
        });
    }

    requirejs.undef('less');
    define('less', {
        load: function (name, parentRequire, load, config) {
            var module = name.replace(/(?:\.less)?$/, ''); // remove extension
            if (themes[module]) {
                require(['text!io.ox/dynamic-theme/apps/' + module +
                         '.less.dyn'], process);
            }
            return lessPlugin.load(name, parentRequire, load, config);
        }
    });

});
