<?xml version="1.0" encoding="UTF-8"?>
<project name   ="mod_grunt"
         basedir=".">

    <!-- =================================================================================
         provide functions around the grunt build environment
      -->
    <description>
    </description>
	
    <!-- =================================================================================
      -->
    <macrodef name="mod_grunt.init">
    <sequential>

		<if>
			<not><isset property="mod_grunt.is-initialized" /></not>
			<then>
				<echo message="init ..." />
		
				<property environment="mod_grunt.env"/>

				<property name="mod_grunt.path.user-env"    value="${user.home}/.builddev"                                           /><!-- This path must be in sync with oxbuild environment ! -->
				<property name="mod_grunt.file.user-config" value="${mod_grunt.path.user-env}/config/general/jsbuild-env.properties" />
		
				<condition property="mod_grunt.is-windows">
					<os family="windows" />
				</condition>
	
				<condition property="mod_grunt.is-mac">
					<os family="mac" />
				</condition>
	
				<condition property="mod_grunt.is-linux">
					<os family="unix" />
				</condition>

				<mod_grunt.-impl-init-defaults         />
				<mod_grunt.-impl-init-from-magic       />
				<mod_grunt.-impl-init-from-env         />
				<mod_grunt.-impl-init-from-user-config />
		
				<echoproperties prefix="mod_grunt."/>

				<fail unless="mod_grunt.exe.npm"   message="miss NPM   executable ..." />
				<fail unless="mod_grunt.exe.bower" message="miss BOWER executable ..." />
				<fail unless="mod_grunt.exe.grunt" message="miss GRUNT executable ..." />

				<var name="mod_grunt.is-initialized" value="true" />
		
			</then>
		</if>
    </sequential>
    </macrodef>

    <!-- =================================================================================
      -->
    <macrodef name="mod_grunt.prepare-gruntenv-in-project">
    	<attribute name="prjpath" />
    <sequential>

        <mod_grunt.init />

		<echo message="check if project '@{prjpath}' needs to be prepared for NPM and BOWER ..." />
		<mod_done.is-done done-id="@{prjpath}"
						  is-done="local.is-done"
		/>
		
		<if>
			<istrue value="${local.is-done}" />
			<then>
				<echo message="... NO - was done before" />
			</then>
			<else>
				<echo message="... YES - will do it now" />
				
				<exec executable ="${mod_grunt.exe.npm}"
					  dir        ="@{prjpath}"
					  failonerror="true"
				>
					<env key="PATH" path="${mod_grunt.PATH}" />
					<arg value="install" />
				</exec>

				<exec executable ="${mod_grunt.exe.bower}"
					  dir        ="@{prjpath}"
					  failonerror="true"
				>
					<env key="PATH" path="${mod_grunt.PATH}" />
					<arg value="install" />
				</exec>

				<mod_done.set-done done-id="@{prjpath}"
				/>

			</else>
		</if>

    </sequential>
    </macrodef>

	<!-- =================================================================================
         PUBLIC
         
         clean the project by removing it's output tree's
         
         @param prjpath [IN]
                the project path where output paths must be cleaned for.
      -->
    <macrodef name="mod_grunt.clean">

        <attribute name="prjpath"   />

    <sequential>
        
        <mod_grunt.init />
        
        <mod_grunt.-impl-grunt prjpath="@{prjpath}">
	        <arg value="clean" />
        </mod_grunt.-impl-grunt>
        
		<mod_grunt.-impl-clean-specials prjpath="@{prjpath}" />
        
    </sequential>
    </macrodef>

    <!-- =================================================================================
         PUBLIC
         
         build the project full
         
         @param prjpath [IN]
                the project path to be build here.
      -->
    <macrodef name="mod_grunt.build-full">

        <attribute name="prjpath"   />

    <sequential>
        
        <mod_grunt.init />

        <mod_grunt.-impl-grunt prjpath="@{prjpath}"
        />
        <mod_grunt.-impl-deploy prjpath="@{prjpath}"
        />
        
    </sequential>
    </macrodef>

    <!-- =================================================================================
         PUBLIC
         
         build the project incremental (changes only)
         
         @param prjpath [IN]
                the project path to be build here.
      -->
    <macrodef name="mod_grunt.build-incremental">

        <attribute name="prjpath"   />

    <sequential>
        
        <mod_grunt.init />

        <mod_grunt.-impl-grunt prjpath="@{prjpath}"
        />
        <mod_grunt.-impl-deploy prjpath="@{prjpath}"
        />
        
    </sequential>
    </macrodef>

    <!-- =================================================================================
      -->
    <macrodef name="mod_grunt.-impl-deploy">
        <attribute name="prjpath" />
    <sequential>
    
    	<echo message="deploy frontend files ..." />
    
    	<if>
			<equals arg1="${mod_grunt.mode}" arg2="appserver" />
			<then>
				<echo message="... to appserver" />
			</then>
    	</if>

    	<if>
			<equals arg1="${mod_grunt.mode}" arg2="apache" />
			<then>
				<echo message="... to apache" />
				
				<fail unless ="mod_grunt.path.apache"
				      message="Miss configured path to apache documents. Did you define 'path.apache' in jsbuild-env.properties file ?"
				/>
				
				<mod_grunt.-impl-get-appsuite-path appsuite-path="local.path.appsuite-in-apache" />
				
				<mkdir dir="${local.path.appsuite-in-apache}" />
				
				<copy todir="${local.path.appsuite-in-apache}">
					<fileset dir="@{prjpath}/build" />
				</copy>
			</then>
    	</if>
    
    </sequential>
    </macrodef>

    <!-- =================================================================================
      -->
    <macrodef name="mod_grunt.-impl-clean-specials">
    <attribute name="prjpath" />
    <sequential>
    
        <!-- check for /web/ui ...
             otherwhise office-web/ui will be detected too :-)
          -->
        <mod_utils.string-contains string     ="@{prjpath}"
        						   search     ="/web/ui"
        						   result-prop="local.is-web-project"
        />
        
        <if>
			<istrue value="${local.is-web-project}" />
	        <then>

		        <mod_grunt.-impl-clean-apache-if-needed prjpath="@{prjpath}" />
		        <mod_done.clean-db />

			</then>
		</if>
    
    </sequential>
    </macrodef>

    <!-- =================================================================================
         tricky : we are called for every frontend project separately ...
                  so it's not a good idea to clean the apache path on every call ...
                  Do it for the FIRST project of build chain only ...
                  thats the web/ui project .-)
      -->
    <macrodef name="mod_grunt.-impl-clean-apache-if-needed">
    <attribute name="prjpath" />
	<sequential>
        
        <if>
			<equals arg1="${mod_grunt.mode}" arg2="apache" />
	        <then>
				<mod_grunt.-impl-get-appsuite-path appsuite-path="local.path.appsuite-in-apache" />
				<delete dir="${local.path.appsuite-in-apache}" />
			</then>
		</if>
        
    </sequential>
    </macrodef>

    <!-- =================================================================================
      -->
    <macrodef name="mod_grunt.-impl-init-defaults">
    <sequential>
    
    	<var name="mod_grunt.mode" value="appserver" />
    
    </sequential>
    </macrodef>

    <!-- =================================================================================
      -->
    <macrodef name="mod_grunt.-impl-init-from-magic">
    <sequential>

    	<echo message="scan your system and do some magic ..." />

		<var name="local.done" value="false" />
        <if>
        	<and>
				<isfalse value="${local.done}"           />
				<istrue  value="${mod_grunt.is-windows}" />
            </and>
            <then>
                <echo message="define environment for WINDOWS ..." />
                <mod_grunt.-impl-init-env-4-windows />
                <var name="local.done" value="true" />
            </then>
        </if>
        <if>
        	<and>
				<isfalse value="${local.done}"       />
				<istrue  value="${mod_grunt.is-mac}" />
    		</and>
            <then>
                <echo message="define environment for MAC ..." />
                <mod_grunt.-impl-init-env-4-mac />
                <var name="local.done" value="true" />
            </then>
        </if>
        <if>
        	<and>
				<isfalse value="${local.done}"         />
				<istrue  value="${mod_grunt.is-linux}" />
    		</and>
            <then>
                <echo message="define environment for LINUX ..." />
                <mod_grunt.-impl-init-env-4-linux />
                <var name="local.done" value="true" />
            </then>
        </if>
    </sequential>
    </macrodef>

    <!-- =================================================================================
      -->
    <macrodef name="mod_grunt.-impl-init-env-4-windows">
    <sequential>

		<var name ="local.exe.grunt"
		     value="${user.home}/AppData/Roaming/npm/grunt.cmd"
		/>
	    <if>
            <available file="${local.exe.grunt}" />
            <then>
	            <echo message="... found GRUNT exe at '${local.exe.grunt}'" />
            	<var name="mod_grunt.exe.grunt" value="${local.exe.grunt}" />
            </then>
        </if>

		<var name ="local.exe.npm"
		     value="c:/progra~1/nodejs/npm.cmd"
		/>
	    <if>
            <available file="${local.exe.npm}" />
            <then>
	            <echo message="... found NPM exe at '${local.exe.npm}'" />
            	<var name="mod_grunt.exe.npm" value="${local.exe.npm}" />
            </then>
        </if>

		<var name ="local.exe.bower"
		     value="${user.home}/AppData/Roaming/npm/bower.cmd"
		/>
	    <if>
            <available file="${local.exe.bower}" />
            <then>
	            <echo message="... found BOWER exe at '${local.exe.bower}'" />
            	<var name="mod_grunt.exe.bower" value="${local.exe.bower}" />
            </then>
        </if>

        <if>
            <available file="${user.home}/AppData/Roaming/npm" />
            <then>
        		<var name ="mod_grunt.PATH"
        			 value="${mod_grunt.PATH}${path.separator}${user.home}/AppData/Roaming/npm"
        		/>
        	</then>
        </if>

        <if>
            <available file="c:/progra~1/nodejs" />
            <then>
        		<var name ="mod_grunt.PATH"
        			 value="${mod_grunt.PATH}${path.separator}c:/progra~1/nodejs"
        		/>
        	</then>
        </if>

    </sequential>
    </macrodef>

	<!-- =================================================================================
      -->
    <macrodef name="mod_grunt.-impl-init-env-4-mac">
    <sequential>

		<var name ="local.exe.grunt"
		     value="/opt/local/bin/grunt"
		/>
        <if>
            <available file="${local.exe.grunt}" />
            <then>
	            <echo message="... found GRUNT exe at '${local.exe.grunt}'" />
            	<var name="mod_grunt.exe.grunt" value="${local.exe.grunt}" />
            </then>
        </if>

		<var name ="local.exe.npm"
		     value="/opt/local/bin/npm"
		/>
        <if>
            <available file="${local.exe.npm}" />
            <then>
	            <echo message="... found NPM exe at '${local.exe.npm}'" />
            	<var name="mod_grunt.exe.npm" value="${local.exe.npm}" />
            </then>
        </if>

		<var name ="local.exe.bower"
		     value="/opt/local/bin/bower"
		/>
        <if>
            <available file="${local.exe.bower}" />
            <then>
	            <echo message="... found BOWER exe at '${local.exe.bower}'" />
            	<var name="mod_grunt.exe.bower" value="${local.exe.bower}" />
            </then>
        </if>
        
        <if>
            <available file="/opt/local/bin" />
            <then>
        		<var name="mod_grunt.PATH" value="${mod_grunt.PATH}${path.separator}/opt/local/bin" />
        	</then>
        </if>

        <if>
            <available file="/opt/local/sbin" />
            <then>
        		<var name="mod_grunt.PATH" value="${mod_grunt.PATH}${path.separator}/opt/local/sbin" />
        	</then>
        </if>

        <if>
            <available file="/Library/WebServer/Documents" />
            <then>
        		<var name="mod_grunt.path.apache" value="/Library/WebServer/Documents" />
        	</then>
        </if>
        
    </sequential>
    </macrodef>

    <!-- =================================================================================
      -->
    <macrodef name="mod_grunt.-impl-init-env-4-linux">
    <sequential>

		<var name ="local.exe.grunt"
		     value="/usr/local/bin/grunt"
		/>
        <if>
            <available file="${local.exe.grunt}" />
            <then>
	            <echo message="... found GRUNT exe at '${local.exe.grunt}'" />
            	<var name="mod_grunt.exe.grunt" value="${local.exe.grunt}" />
            </then>
        </if>

		<var name ="local.exe.npm"
		     value="/usr/bin/npm"
		/>
        <if>
            <available file="${local.exe.npm}" />
            <then>
	            <echo message="... found NPM exe at '${local.exe.npm}'" />
            	<var name="mod_grunt.exe.npm" value="${local.exe.npm}" />
            </then>
        </if>

		<var name ="local.exe.bower"
		     value="/usr/local/bin/bower"
		/>
        <if>
            <available file="${local.exe.bower}" />
            <then>
	            <echo message="... found BOWER exe at '${local.exe.bower}'" />
            	<var name="mod_grunt.exe.bower" value="${local.exe.bower}" />
            </then>
        </if>

		<!-- seems the PATH variable is good enough on linux .-) -->
		
		<if>
			<available file="/var/www" />
            <then>
        		<var name="mod_grunt.path.apache" value="/var/www" />
        	</then>
        </if>

    </sequential>
    </macrodef>

	<!-- =================================================================================
      -->
    <macrodef name="mod_grunt.-impl-init-from-env">
    <sequential>

		<!-- handle windows different : There "Path" is used instead of "PATH" ! -->
        <if>
        	<and>
				<istrue value   ="${mod_grunt.is-windows}" />
				<isset  property="mod_grunt.env.Path"      />
            </and>
			<then>
				<var name ="mod_grunt.PATH"
					 value="${mod_grunt.env.Path}"
				/>
			</then>
		</if>

        <if>
        	<and>
        		<or>
				<istrue value   ="${mod_grunt.is-mac}"   />
				<istrue value   ="${mod_grunt.is-linux}" />
        		</or>
				<isset  property="mod_grunt.env.PATH"  />
            </and>
			<then>
				<var name ="mod_grunt.PATH"
					 value="${mod_grunt.env.PATH}"
				/>
			</then>
		</if>

    </sequential>
    </macrodef>

    <!-- =================================================================================
      -->
    <macrodef name="mod_grunt.-impl-init-from-user-config">
    <sequential>

        <echo message="search for config file ${mod_grunt.file.user-config} ..." />

        <if>
            <available file="${mod_grunt.file.user-config}" />
        	<then>
                <echo message="load config file ${mod_grunt.file.user-config} ..." />
        		<property file  ="${mod_grunt.file.user-config}"
        				  prefix="local.env."
        		/>

        		<echoproperties prefix="local.env." />
        		
				<if>
					<isset property="local.env.exe.bower" />
					<then>
						<var name ="mod_grunt.exe.bower"
						     value="${local.env.exe.bower}"
						/>
					</then>
				</if>
				<if>
					<isset property="local.env.exe.npm" />
					<then>
						<var name ="mod_grunt.exe.npm"
						     value="${local.env.exe.npm}"
						/>
					</then>
				</if>
				<if>
					<isset property="local.env.exe.grunt" />
					<then>
						<var name ="mod_grunt.exe.grunt"
						     value="${local.env.exe.grunt}"
						/>
					</then>
				</if>
				<if>
					<isset property="local.env.env.path" />
					<then>
						<!-- path.separator comes from ANT ! -->
						<var name ="mod_grunt.PATH"
						     value="${mod_grunt.PATH}${path.separator}${local.env.env.path}"
						/>
					</then>
				</if>
				<if>
					<isset property="local.env.mode" />
					<then>
						<var name ="mod_grunt.mode"
						     value="${local.env.mode}"
						/>
					</then>
				</if>
				<if>
					<isset property="local.env.path.apache" />
					<then>
						<var name ="mod_grunt.path.apache"
						     value="${local.env.path.apache}"
						/>
					</then>
				</if>

			</then>
        	<else>
                <echo message="... no user config file" />
        	</else>
        </if>

    </sequential>
    </macrodef>

    <!-- =================================================================================
      -->
    <macrodef name="mod_grunt.-impl-get-appsuite-path">
    <attribute name="appsuite-path" />
    <sequential>
    
    	<fail unless ="mod_grunt.path.apache"
    	      message="Miss apache path. Did you configure it ?"
    	/>
    
    	<var name ="@{appsuite-path}"
    	     value="${mod_grunt.path.apache}/appsuite" />
    
    </sequential>
    </macrodef>

    <!-- =================================================================================
         PRIVATE
         
         calls the JS Grunt environment to do a build .-)
         
         @param prjpath [IN]
                the project path to be build here.

         @param arguments [IN]
                optional list of arguments passed to underlying GRUNT call.
      -->
    <macrodef name="mod_grunt.-impl-grunt">

        <attribute name="prjpath"   />
        <element   name="arguments" implicit="true" optional="true" />

    <sequential>

		<echo message="PATH = ${mod_grunt.PATH}" />
		<echo message="prj  = @{prjpath}"        />
		
        <exec executable ="${mod_grunt.exe.grunt}"
              dir        ="@{prjpath}"
        	  failonerror="true"
        >
	        <env key="PATH" path="${mod_grunt.PATH}" />
	        <arg value="--no-color" />
            <arguments />
        </exec>

    </sequential>
    </macrodef>

</project>
